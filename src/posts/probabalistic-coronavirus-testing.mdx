---
title: Probabalistic Coronavirus Testing
date: 2020-08-22 10:10:41
status: draft
---

In an effort to get test coverage to all employees, some hospitals are starting to batch together tests. The basic idea is to mix a bunch of employee samples together and run a single test on the mixture, rather than running a test for each employee. This is very clever, and can allow for much higher test coverage while limiting the number of tests that need to be run, but might need a little more explanation. 

Imagine that you had ten people, but very few tests. We could mix all their samples together and just cancel work that day of the test came back positive, but if we can afford to run multiple tests it becomes easier to refine this strategy. For instance, with five tests (pretending for now that the tests are perfect) we can figure out exactly who is sick. 

Pick two tests for each person, and add their sample to those mixtures. Make sure nobody has the same two tests. We know this is possible because there are exactly ten ways to choose two items out of a set of five. When we run these tests, we know that anyone who is sick will have both of their tests come back positive, and we can ask just those people not to come to work. With half as many tests as people, we were able to exactly identify who was sick. But this trick is actually even more powerful than that. 

### Numbers can be very large

We needed five tests in this case because there are ten ways to pick two items from a set of five. This idea of the number of ways to pick $m$ items from a set of $n$ items is key here, and is usually called $n$ _choose_ $m$, or ${n \choose m}$. These numbers are called [binomial coefficients](https://en.wikipedia.org/wiki/Binomial_coefficient). They will always be largest when $m$ is close to $n/2$, and are _very, very large_ compared to $n$ as long as $m$ isn't close to 1 or $n$.

For example, there are ${52 \choose 5}$ possible hands in five card poker; the number of ways to choose five cards from a deck of 52. That's $2,598,960$. That number gets larger the closer the size of the hand is to half the size of the deck, maxing out at ${52 \choose 26} = 495,918,532,948,104$, or about a hundred thousand times as many people as are currently alive. Incidentally, that number also means that with just $36$ tests we could use this approach to test everyone who is currently alive, although logistically that might still be challenging. But it gets even better.

### Real world testing

Tests are not perfectly accurate. They have a false positive rate $\alpha$, where people aren't sick but test positive, and a false negative rate $\beta$, where people are sick but test negative. These numbers are usually fairly small, but can still lead to [big problems](https://www.forbes.com/sites/startswithabang/2020/05/07/this-is-how-false-positives-and-false-negatives-can-bias-covid-19-testing/#317eee611743). One way to help control for these numbers is to have people take multiple tests, to help try and control for these errors, but that can be expensive because many people will need to retake tests. In our "everyone in the world" example, each individual person had their sample tested a total of $18$ times. These tests overlap with other people, so we don't get quite the same advantage of truly independent testing, but it still dramatically decreases the odds of false positives, at the cost of somewhat increasing the odds of false negatives. 

The worst case for the false negative rate is when there is only one person sick out of the whole batch of tests. This is because there is some probability that if someone else is sick, they will share a test with you, which swamps the odds of your test being a false negative. So if we have only one sick person and some false negative rate $\beta$, and they will be tested a total of $18$ times, what are the odds that they get a false negative?

Remember that a "positive" result in this scheme only occurs if every test that a person was mixed into comes back positive. So a false negative occurs when any one of the 18 individual tests come back negative. Then the odds are $1-(1-\beta)^{18}=16%$. That is uncomfortably high. But we can control that number by changing what we consider a positive result. If we instead count anyone who gets $17/18$ positive results, or $16/18$, etc. we can steadily decrease the false negative rate. In fact, the false negative rate is directly related to the binomial coefficients that we used to motivate the scheme in the first place. The probability that someone gets a false negative on $m/n$ tests is ${n \choose m}*\beta^m*(1-\beta)^{n-m}$. As we move towards requiring that anyone who tests positive on a _majority_ of their tests will be considered testing positive, we get very close to our initial false negative rate of just $\beta$.

Of course, lowering our standard of positive in that way increases our odds of a false positive, especially when there is more than one person in a batch who is sick. However, that probability can be controlled by just increasing the number of tests, and once again because of just how large binomial coefficients can get, we don't need to increase the number of tests by that much; running 4 times as many tests and looking for a majority of positives should get us a _better_ false positive rate than only running the 36 tests and looking for unanimous positives.

### Everything has limits

Unfortunately, this hinges on a few numbers that I don't think we have. All of this looks spectacularly good if tests are truly uncorrelated. That means that we would need to know that the odds of getting a false negative ($\Rho(N_f) = \beta$) are the same as the odds of getting a false negative given that we've already gotten one $\Rho(N_{f2} | N_f) = \beta$. This is _definitely not true_. It's probably not even close to true, and we have a similar problem with false positives. However, as far as I know we don't have any real idea of what those probabilities are. But even in the case where if you get any false tests, all of your tests are likely to be false, smaller scale batching of tests in this way can dramatically decrease the number of tests that we would need to run.